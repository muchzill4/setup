#!/bin/sh
sessions=$(
    tmux list-sessions |
    cut -d : -f 1 |
    sort
)

projects_path="$HOME/Dev"
projects=$(
    find "$projects_path"/* -maxdepth 1 -mindepth 1 -type d |
    sed "s~$projects_path/~~" |
    sort
)

projects_without_sessions=$(echo "$projects" | grep -vxF "$sessions")

session_prefix="! "
prefixed_sessions=$(echo "$sessions" | sed "s~^~$session_prefix~")

selected=$(
  (
    echo "$prefixed_sessions";
    echo "$projects_without_sessions"
  ) |
  fzf --tmux 30% --cycle --layout=reverse
)

if [ -n "$selected" ]; then
  if [ "${selected#$session_prefix}" != "$selected" ]; then
    session_name=$(echo "$selected" | sed "s~$session_prefix~~")
    if [ -n "$TMUX" ]; then
      tmux switch-client -t "$session_name"
    else
      tmux attach-session -t "$session_name"
    fi
  else
    directory=$(echo $selected | sed "s~^~$projects_path/~")
    if [ -n "$TMUX" ]; then
      tmux new -c "$directory" -d -s "$selected" && tmux switch-client -t "$selected"
    else
      tmux new -c "$directory" -A -s "$selected"
    fi
  fi
fi
